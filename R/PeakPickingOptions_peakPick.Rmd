---
title: "PeakPickingOptions_chemometricswithR"
author: "Sarah Shiers"
date: "2026-01-10"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Start by loading the required packages

```{r, load packages, message=FALSE}
library("easypackages") 
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr","tidyr","ggplot2")
```

## Load required packages

```{r}

source(here('R',"TukeySmoothing.R"))

###USER-DEFINED FIELDS####
baseDir <- 'E:/Analysis/'
DriftID<-'ADRIFT_033'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries

# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')

pps <- PAMpalSettings(db=db, 
                      binaries = binFolder,
                      sr_hz='auto', 
                      winLen_sec=.0025, 
                      filterfrom_khz=10, 
                      filterto_khz=80)

study <- processPgDetections(pps)

study<-dplyr::filter(study,Channel==1)       
 
#Calculate average spectrum with and without Tukey smoothing
#Use 1024 window length for 375 Hz frequency resolution (Soldevilla used 400 Hz) 
smooth <- calculateAverageSpectra_tukey(
  study,
  evNum = 1,
  channel=1,
  tukeyMedian = 5,
  tukeyHanningSize = 5,
  plot=FALSE,
  wl=1024
)

raw <- calculateAverageSpectra(
  study,
  evNum = 1,
  channel=1,
  plot=FALSE,
  wl=1024
)

ylim <- range(c(raw$avgSpec, smooth$avgSpec), na.rm = TRUE)

```

### Save images in "Smooth Options" folder

```{r}
out_root <-  file.path(baseDir,'Smooth Options')
drift_dir <- fs::path(out_root, DriftID)
dir_create(drift_dir)

event_ids<-1
event_name <- paste0(DriftID, "_Event_", str_pad(event_ids, 3, pad = "0"))

 #Plot and save images
  pattern <- fs::path(drift_dir, paste0(event_name,"_Smooths.png"))
  png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
  
plotCompareSpectra(raw, smooth, main = paste0(event_name,": Raw vs Tukey"))
  dev.off()
```

### Plot click spectra showing raw signal, with 5-point Hann smooth and Tukey double smooth  

```{r}

#Plot one click
plot(raw$freq,raw$allSpec[,1],type='l',xlab="Frequency (kHz)",ylab="Level(dB)",xlim=c(19000,50000))
lines(smooth$freq, smooth$allSpec[,1], lwd = 2)
legend("bottomright", legend = c("Raw", "Tukey"), lwd = c(1, 2), bty = "n")

#Plot a single click by UID, then step through clicks interactively (press Enter to advance)next
browse_clicks(raw, tukeyMedian = 5, tukeyHanningSize = 5, fmin_khz = 19, fmax_khz = 50)
```

### Addition of peakPick

```{R}

library(signal)
library(dplyr)
library(matrixStats)
library(peakPick)

#Ensure kHz is being used
to_khz <- function(freq) if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq

hann5_smooth <- function(y) {
  w <- signal::hanning(5)
  w <- w / sum(w)
  y_pad <- c(rep(y[1], 2), y, rep(y[length(y)], 2))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[3:(length(y_filt) - 2)])
}

#Select one click and build spectra
click_i <- 1
click_uid <- as.character(raw$UID[click_i])

freq_khz <- to_khz(raw$freq)

y_raw   <- raw$allSpec[, click_i]
y_tukey <- smooth$allSpec[, click_i]
y_hann5 <- hann5_smooth(y_raw)

#peakPick wrapper
detect_peaks_peakPick <- function(y, freq_khz,
                                  fmin_khz = 19, fmax_khz = 50,
                                  neighlim = 2,
                                  deriv.lim = 0.03,
                                  peak.min.sd = 0.5,
                                  peak.npos = 10L) {

  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  if (length(y_band) < 5) {
    return(data.frame(peak_frequency_khz = numeric(), peak_level_db = numeric()))
  }

  res <- peakPick::peakpick(
    matrix(y_band, ncol = 1),
    neighlim    = neighlim,
    deriv.lim   = deriv.lim,
    peak.min.sd = peak.min.sd,
    peak.npos   = peak.npos,
    mc.cores    = 1
  )

  #peakPick usually returns an indicator matrix (0/1) with same length as input
  idx <- integer(0)
  if (is.matrix(res) && nrow(res) == length(y_band)) {
    idx <- which(res[, 1] != 0)
  } else if (is.logical(res) && length(res) == length(y_band)) {
    idx <- which(res)
  } else if (is.numeric(res) && length(res) == length(y_band)) {
    idx <- which(res != 0)
  }

  if (length(idx) == 0) {
    return(data.frame(peak_frequency_khz = numeric(), peak_level_db = numeric()))
  }

  data.frame(
    peak_frequency_khz = x_band[idx],
    peak_level_db      = y_band[idx]
  )
}

#Apply to smoothed spectrum
spectra_by_smoothing <- list(Raw = y_raw, Tukey = y_tukey, Hann5 = y_hann5)

peaks_by_smoothing_peakPick <- lapply(
  spectra_by_smoothing,
  detect_peaks_peakPick,
  freq_khz = freq_khz,
  fmin_khz = 19,
  fmax_khz = 50,
  neighlim = 2
)

#Raw return
band_raw <- freq_khz >= 19 & freq_khz <= 50 & is.finite(y_raw)
res_raw <- peakPick::peakpick(
  matrix(y_raw[band_raw], ncol=1),
  neighlim=2, deriv.lim=0.03, peak.min.sd=0.5, peak.npos=10L, mc.cores=1
)

cat("UID:", click_uid, "\n")
cat("Band bins (Raw):", sum(band_raw), "\n")
cat("peakPick output class:", class(res_raw), "\n")
if (is.matrix(res_raw)) {
  cat("peakPick output dim:", paste(dim(res_raw), collapse=" x "), "\n")
  print(table(res_raw[,1]))
}

#Peak tables (null)
peaks_by_smoothing_peakPick$Raw
peaks_by_smoothing_peakPick$Tukey
peaks_by_smoothing_peakPick$Hann5


#Confirming banding
band_raw <- freq_khz >= 19 & freq_khz <= 50 & is.finite(y_raw)
cat("band bins:", sum(band_raw), "\n")
cat("band range y:", paste(range(y_raw[band_raw], na.rm=TRUE), collapse=" to "), "\n")
cat("band sd:", sd(y_raw[band_raw], na.rm=TRUE), "\n")

x <- y_raw[band_raw]
res_raw <- peakPick::peakpick(matrix(x, ncol=1),
                              neighlim=2, deriv.lim=0.03, peak.min.sd=0.5, peak.npos=10L, mc.cores=1)

cat("res_raw is matrix:", is.matrix(res_raw), "\n")
if (is.matrix(res_raw)) {
  cat("res_raw dim:", paste(dim(res_raw), collapse=" x "), "\n")
  cat("nonzero count:", sum(res_raw[,1] != 0), "\n")
  print(table(res_raw[,1]))
}

#Checking for non zeroes
x <- y_raw[band_raw]

res_raw <- peakPick::peakpick(
  matrix(x, ncol = 1),
  neighlim    = 2,
  deriv.lim   = 0.03,
  peak.min.sd = 0.5,
  peak.npos   = 10L,
  mc.cores    = 1
)

cat("res_raw is matrix:", is.matrix(res_raw), "\n")
cat("res_raw dim:", paste(dim(res_raw), collapse=" x "), "\n")
cat("nonzero count:", sum(res_raw[,1] != 0), "\n")
print(table(res_raw[,1]))

#Loose test
res_raw_loose <- peakPick::peakpick(
  matrix(y_raw[band_raw], ncol = 1),
  neighlim    = 1,
  deriv.lim   = 1e6,
  peak.min.sd = 0,
  peak.npos   = 500L,
  mc.cores    = 1
)

cat("nonzero count (loose):", sum(res_raw_loose[,1] != 0), "\n")
print(table(res_raw_loose[,1]))


```













