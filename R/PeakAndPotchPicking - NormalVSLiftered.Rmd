---
title: "PeakAndPotchPicking - NormalVSLiftered"
author: "Sarah Shiers"
date: "2026-02-08"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

### Packages

```{r}

library("easypackages")
libraries(
  "PAMpal","PAMmisc","dplyr","here","lubridate","purrr","signal","fs","stringr",
  "tidyr","ggplot2","pracma","quantmod","tibble"
)

```

### Source files (run once per R session)

```{r}

source(here('R',"TukeySmoothing.R"))
source(here('R','lifteredClickCalcs.R'))

```

### User inputs (run per drift / event)

```{r}

baseDir <- "E:/Analysis/"
DriftID <- "ADRIFT_003"
evNum   <- 1         # 1-based event number you want
channel <- 1
wl      <- 1024

# Tukey parameters (keep consistent across normal + liftered)
tukeyMedian      <- 5
tukeyHanningSize <- 5

# Peak/notch detection band (kHz)
fmin_khz <- 19
fmax_khz <- 50

# Peak picking knobs
min_peak_separation_khz <- 0.3
peak_height_quantile    <- 0.10

```

### Output RDS files (run once per R session)

```{r}

outDir <- "C:/Users/sarah/OneDrive/Documents/GitHub/Rissos_Geographic_Variation/R"
fs::dir_create(outDir)

normal_rds <- file.path(outDir, "extrema_normal.rds")
lifter_rds <- file.path(outDir, "extrema_liftered.rds")

```

### Helper functions (run once per R session)

```{r}
to_khz <- function(freq_hz) {
  if (max(freq_hz, na.rm = TRUE) > 1000) freq_hz / 1000 else freq_hz
}

hann_smooth <- function(y, n = 5) {
  w <- signal::hanning(n)
  w <- w / sum(w)
  pad <- floor(n/2)
  y_pad <- c(rep(y[1], pad), y, rep(y[length(y)], pad))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[(pad+1):(length(y_filt)-pad)])
}

tukey_double_smooth <- function(y, tukeyMedian = 5, tukeyHanningSize = 5) {
  y_med  <- stats::runmed(y, k = tukeyMedian, endrule = "median")
  hann_smooth(y_med, n = tukeyHanningSize)
}

spectra_from_waves <- function(waves, sr_hz, wl = 1024) {
  waves <- waves[!is.na(waves)]
  if (length(waves) == 0) stop("No waves provided to spectra_from_waves().")

  freq_hz <- (0:(wl/2)) * (sr_hz / wl)

  spec_list <- lapply(waves, function(w) {
    w <- as.numeric(w)
    if (length(w) < wl) {
      w <- c(w, rep(0, wl - length(w)))
    } else if (length(w) > wl) {
      w <- w[1:wl]
    }

    win <- signal::hanning(wl)
    w_win <- w * win

    X <- fft(w_win)
    mag <- Mod(X)[1:(wl/2 + 1)]
    20 * log10(mag + 1e-12)
  })

  allSpec <- do.call(cbind, spec_list)
  avgSpec <- rowMeans(allSpec, na.rm = TRUE)

  list(freq_hz = freq_hz, allSpec = allSpec, avgSpec = avgSpec)
}

detect_peaks_pracma <- function(y, freq_khz,
                               fmin_khz, fmax_khz,
                               min_peak_separation_khz,
                               peak_height_quantile) {
  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]
  if (length(y_band) < 5) return(data.frame(freq_khz = numeric(), level_db = numeric()))

  freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)
  min_peak_separation_bins <- max(1, round(min_peak_separation_khz / freq_resolution_khz))
  min_peak_height_db <- as.numeric(quantile(y_band, probs = peak_height_quantile, na.rm = TRUE))

  peaks <- pracma::findpeaks(
    y_band,
    minpeakheight   = min_peak_height_db,
    minpeakdistance = min_peak_separation_bins
  )

  if (is.null(peaks) || nrow(peaks) == 0) {
    data.frame(freq_khz = numeric(), level_db = numeric())
  } else {
    idx <- peaks[, 2]
    data.frame(freq_khz = x_band[idx], level_db = y_band[idx])
  }
}

detect_notches_quantmod <- function(y, freq_khz, fmin_khz, fmax_khz, shift_back = TRUE) {
  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]
  if (length(y_band) < 5) return(data.frame(freq_khz = numeric(), level_db = numeric()))

  idx <- quantmod::findValleys(y_band)
  if (length(idx) == 0) {
    data.frame(freq_khz = numeric(), level_db = numeric())
  } else {
    if (shift_back) idx <- pmax(1, idx - 1)
    data.frame(freq_khz = x_band[idx], level_db = y_band[idx])
  }
}

append_rds <- function(path, df_new) {
  if (file.exists(path)) {
    df_old <- readRDS(path)
    all_cols <- union(names(df_old), names(df_new))
    df_old <- df_old %>% dplyr::mutate(across(setdiff(all_cols, names(df_old)), ~NA))
    df_new <- df_new %>% dplyr::mutate(across(setdiff(all_cols, names(df_new)), ~NA))
    df_out <- dplyr::bind_rows(df_old[, all_cols], df_new[, all_cols])
  } else {
    df_out <- df_new
  }

  df_out <- df_out %>%
    dplyr::distinct(
      DriftID, Event, UID, study_type, smoothing, extrema_type, frequency_khz, level_db,
      .keep_all = TRUE
    )

  saveRDS(df_out, path)
  df_out
}

extract_extrema_for_spec <- function(spec, freq_khz, study_type, DriftID, evNum) {
  UIDs <- as.character(spec$UID)
  nclicks <- ncol(spec$allSpec)

  if (length(UIDs) != nclicks) {
    stop("UID length does not match number of spectra columns.")
  }

  out <- vector("list", nclicks)

  for (j in seq_len(nclicks)) {
    y <- spec$allSpec[, j]

    peaks_j <- detect_peaks_pracma(
      y = y,
      freq_khz = freq_khz,
      fmin_khz = fmin_khz,
      fmax_khz = fmax_khz,
      min_peak_separation_khz = min_peak_separation_khz,
      peak_height_quantile = peak_height_quantile
    ) %>%
      dplyr::rename(frequency_khz = freq_khz, level_db = level_db) %>%
      dplyr::mutate(
        DriftID = DriftID,
        Event = evNum,
        UID = UIDs[j],
        study_type = study_type,
        smoothing = "Tukey",
        extrema_type = "Peak"
      )

    notches_j <- detect_notches_quantmod(
      y = y,
      freq_khz = freq_khz,
      fmin_khz = fmin_khz,
      fmax_khz = fmax_khz,
      shift_back = TRUE
    ) %>%
      dplyr::rename(frequency_khz = freq_khz, level_db = level_db) %>%
      dplyr::mutate(
        DriftID = DriftID,
        Event = evNum,
        UID = UIDs[j],
        study_type = study_type,
        smoothing = "Tukey",
        extrema_type = "Notch"
      )

    out[[j]] <- dplyr::bind_rows(peaks_j, notches_j)
  }

  dplyr::bind_rows(out)
}

```

### PAMpal settings (run per drift / event)

```{r}

binFolder <- file.path(baseDir, "Binaries", DriftID)
db <- file.path(baseDir, "Useable Databases", paste0(DriftID, " - Clean.sqlite3"))

# fail early if path wrong
if (!dir.exists(binFolder)) stop("Binaries folder not found: ", binFolder)
if (!file.exists(db)) stop("DB not found: ", db)

pps_base <- PAMpalSettings(
  db = db,
  binaries = binFolder,
  sr_hz = "auto",
  winLen_sec = 0.0025,
  filterfrom_khz = 10,
  filterto_khz = 80
)

```

### Normal study (run per drift / event)

```{r}

study_normal <- processPgDetections(pps_base) %>%
  dplyr::filter(Channel == channel)

spec_normal <- calculateAverageSpectra_tukey(
  study_normal,
  evNum = evNum,
  channel = channel,
  tukeyMedian = tukeyMedian,
  tukeyHanningSize = tukeyHanningSize,
  plot = FALSE,
  wl = wl
)

freq_khz_normal <- to_khz(spec_normal$freq)

```

### Liftered study (run per drift / event)

```{r}
pps_lift <- addFunction(
  pps_base, lifteredClickCalcs,
  module = "ClickDetector",
  default = TRUE,
  sr_hz = "auto",
  calibration = NULL,
  filterfrom_khz = 10,
  filterto_khz = 80,
  winLen_sec = 0.0025
)

study_lift <- processPgDetections(pps_lift)

lift_df <- getClickData(study_lift)

# optional: filter clickData by channel if present
if ("Channel" %in% names(lift_df)) {
  lift_df <- lift_df %>% dplyr::filter(Channel == channel)
}

# map evNum to eventId group
ev_groups <- split(lift_df, lift_df$eventId)
if (length(ev_groups) == 0) stop("No events found in liftered click data.")
if (evNum < 1 || evNum > length(ev_groups)) stop("evNum out of range for liftered data.")
lift_ev <- ev_groups[[evNum]]

waves_lift <- lift_ev$liftered_wave
uids_lift  <- as.character(lift_ev$UID)

keep <- !is.na(waves_lift) & lengths(waves_lift) > 0
waves_lift <- waves_lift[keep]
uids_lift  <- uids_lift[keep]
if (length(waves_lift) == 0) stop("Selected liftered event has no usable liftered_wave.")

sr_hz <- study_lift[[1]]@settings$sr

spec_lift_raw <- spectra_from_waves(waves_lift, sr_hz = sr_hz, wl = wl)

allSpec_lift_tukey <- apply(
  spec_lift_raw$allSpec, 2, tukey_double_smooth,
  tukeyMedian = tukeyMedian,
  tukeyHanningSize = tukeyHanningSize
)
allSpec_lift_tukey <- as.matrix(allSpec_lift_tukey)

spec_lift <- list(
  freq = spec_lift_raw$freq_hz,
  allSpec = allSpec_lift_tukey,
  avgSpec = rowMeans(allSpec_lift_tukey, na.rm = TRUE),
  UID = uids_lift
)

freq_khz_lift <- to_khz(spec_lift$freq)

```

### Extract peaks + notches (run per drift / event)

```{r}

extrema_normal_new <- extract_extrema_for_spec(
  spec = spec_normal,
  freq_khz = freq_khz_normal,
  study_type = "normal",
  DriftID = DriftID,
  evNum = evNum
)

extrema_lifter_new <- extract_extrema_for_spec(
  spec = spec_lift,
  freq_khz = freq_khz_lift,
  study_type = "liftered",
  DriftID = DriftID,
  evNum = evNum
)

# optional sanity
dplyr::count(extrema_normal_new, extrema_type)
dplyr::count(extrema_lifter_new, extrema_type)


```

### Append to the two RDS files (run per drift / event)

```{r}

normal_all <- append_rds(normal_rds, extrema_normal_new)
lifter_all <- append_rds(lifter_rds, extrema_lifter_new)

tail(normal_all, 10)
tail(lifter_all, 10)

```

### Extrema-count histogram (raw RDS rows)

Saved as: <DriftID>*Event*\<###\>\_Tukey_2x2_extremaCount.png

What this actually is: This histogram counts every row in the RDS. Each
detected peak or notch is counted independently. If one click produces 8
peaks and 8 notches, that single click contributes 16 counts across
bins.

Why counts are high: You are counting extrema instances, not clicks.
This is expected to be the largest-count plot.

```{r}

### Extrema-count histograms (old look): counts ALL detected extrema instances (not clicks)

# output folder
eventDir <- file.path(histBaseDir, DriftID, sprintf("Event_%03d", evNum))
fs::dir_create(eventDir)

# load + filter to this drift/event/tukey
normal_all <- readRDS(normal_rds)
lifter_all <- readRDS(lifter_rds)

df <- dplyr::bind_rows(normal_all, lifter_all) %>%
  dplyr::filter(
    DriftID == DriftID,
    Event == evNum,
    smoothing == "Tukey",
    is.finite(frequency_khz),
    frequency_khz >= fmin_khz,
    frequency_khz <= fmax_khz,
    study_type %in% c("normal", "liftered"),
    extrema_type %in% c("Peak", "Notch")
  ) %>%
  dplyr::mutate(
    study_type   = factor(study_type, levels = c("normal", "liftered")),
    extrema_type = factor(extrema_type, levels = c("Peak", "Notch"))
  )

# plot: same binning idea as the older script (bins = hist_bins)
p_extrema <- ggplot2::ggplot(df, ggplot2::aes(x = frequency_khz)) +
  ggplot2::geom_histogram(bins = hist_bins) +
  ggplot2::facet_grid(study_type ~ extrema_type) +
  ggplot2::scale_x_continuous(
    breaks = seq(fmin_khz, fmax_khz, by = 1),
    minor_breaks = seq(fmin_khz, fmax_khz, by = 0.5),
    limits = c(fmin_khz, fmax_khz)
  ) +
  ggplot2::labs(
    title = paste0(DriftID, " | Event ", evNum, " | Tukey | extrema-count"),
    x = "Frequency (kHz)",
    y = "Count of extrema"
  ) +
  ggplot2::theme_grey(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    plot.title  = ggplot2::element_text(face = "bold")
  )

print(p_extrema)

out_extrema <- file.path(eventDir, sprintf("%s_Event_%03d_Tukey_2x2_extremaCount.png", DriftID, evNum))
ggplot2::ggsave(out_extrema, p_extrema, width = 12, height = 7, dpi = 300)
message("Saved: ", out_extrema)

```

### Binned extrema histogram (still extrema, not clicks)

Saved as: <DriftID>*Event*\<###\>\_Tukey_2x2.png

What this actually is: This is the same data as above, just binned using
geom_histogram(binwidth = 1). No UID logic is applied. No deduplication
occurs. This is not a click-count plot.

Important correction: This plot does not represent “how many clicks show
this frequency.” It represents how many extrema fall in each 1 kHz bin.

Why it looks similar to (1): Because it is the same thing — only
re-binned.

```{r}

histBaseDir <- "E:/Analysis/Event Histograms"
driftDir    <- file.path(histBaseDir, DriftID)
eventDir    <- file.path(driftDir, paste0("Event_", sprintf("%03d", evNum)))
fs::dir_create(eventDir)

x_major <- seq(fmin_khz, fmax_khz, by = 1)
x_minor <- seq(fmin_khz, fmax_khz, by = 0.5)

normal_all <- readRDS(normal_rds)
lifter_all <- readRDS(lifter_rds)

all_extrema <- dplyr::bind_rows(normal_all, lifter_all) %>%
  dplyr::filter(
    DriftID == DriftID,
    Event   == evNum,
    smoothing == "Tukey",
    is.finite(frequency_khz),
    frequency_khz >= fmin_khz,
    frequency_khz <= fmax_khz
  ) %>%
  dplyr::mutate(
    study_type   = factor(study_type, levels = c("normal", "liftered")),
    extrema_type = factor(extrema_type, levels = c("Peak", "Notch"))
  )

if (nrow(all_extrema) == 0) {
  stop("No Tukey extrema rows found for ", DriftID, " Event ", evNum)
}

p_2x2 <- ggplot2::ggplot(all_extrema, ggplot2::aes(x = frequency_khz)) +
  ggplot2::geom_histogram(
    binwidth = 1,
    boundary = fmin_khz
  ) +
  ggplot2::facet_grid(study_type ~ extrema_type) +
  ggplot2::scale_x_continuous(
    breaks = x_major,
    minor_breaks = x_minor,
    limits = c(fmin_khz, fmax_khz)
  ) +
  ggplot2::labs(
    title = paste0(DriftID, " | Event ", evNum, " | Tukey"),
    x = "Frequency (kHz)",
    y = "Number of clicks"
  ) +
  ggplot2::theme_grey(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    plot.title  = ggplot2::element_text(face = "bold")
  )

print(p_2x2)

out_png <- file.path(
  eventDir,
  sprintf("%s_Event_%03d_Tukey_2x2.png", DriftID, evNum)
)

ggplot2::ggsave(out_png, p_2x2, width = 12, height = 7, dpi = 300)
message("Saved: ", out_png)

```

### Click-count histogram (unique UID per 1 kHz bin)

Saved as: <DriftID>*Event*\<###\>\_Tukey_2x2_perUID.png

What this actually is: This histogram explicitly collapses the data so
that each UID can contribute at most one count per bin. If a click has
multiple peaks or notches inside the same 1 kHz bin, it is still counted
once.

What question this answers: “How many unique clicks show at least one
peak/notch in this frequency bin?”

Critical clarification: This is the only plot that matches the
conceptual intent of the original histograms.

```{r}

histBaseDir <- "E:/Analysis/Event Histograms"
driftDir    <- file.path(histBaseDir, DriftID)
eventDir    <- file.path(driftDir, paste0("Event_", sprintf("%03d", evNum)))
fs::dir_create(eventDir)

normal_all <- readRDS(normal_rds)
lifter_all <- readRDS(lifter_rds)

all_extrema <- dplyr::bind_rows(normal_all, lifter_all) %>%
  dplyr::filter(
    DriftID == DriftID,
    Event   == evNum,
    smoothing == "Tukey",
    is.finite(frequency_khz),
    frequency_khz >= fmin_khz,
    frequency_khz <= fmax_khz
  ) %>%
  dplyr::mutate(
    study_type   = factor(study_type, levels = c("normal", "liftered")),
    extrema_type = factor(extrema_type, levels = c("Peak", "Notch"))
  )

if (nrow(all_extrema) == 0) stop("No Tukey extrema rows found for this DriftID/Event in RDS.")

# 1) Assign each extrema to a 1 kHz bin [k, k+1)
# 2) Deduplicate: one count per UID per bin (presence)
uid_bin_presence <- all_extrema %>%
  dplyr::mutate(bin_khz = floor(frequency_khz)) %>%
  dplyr::filter(bin_khz >= fmin_khz, bin_khz <= fmax_khz) %>%
  dplyr::distinct(study_type, extrema_type, UID, bin_khz)

uid_counts <- uid_bin_presence %>%
  dplyr::count(study_type, extrema_type, bin_khz, name = "n_clicks")

all_bins <- tibble::tibble(bin_khz = seq(fmin_khz, fmax_khz, by = 1))
uid_counts <- uid_counts %>%
  tidyr::complete(study_type, extrema_type, bin_khz = all_bins$bin_khz, fill = list(n_clicks = 0))

x_major <- seq(fmin_khz, fmax_khz, by = 1)
x_minor <- seq(fmin_khz, fmax_khz, by = 0.5)

p_uid <- ggplot2::ggplot(uid_counts, ggplot2::aes(x = bin_khz, y = n_clicks)) +
  ggplot2::geom_col(width = 1) +  # exactly 1 kHz wide bars
  ggplot2::facet_grid(study_type ~ extrema_type) +
  ggplot2::scale_x_continuous(
    breaks = x_major,
    minor_breaks = x_minor,
    limits = c(fmin_khz, fmax_khz + 1),   # +1 so last bin [50,51) has room if fmax=50
    expand = c(0, 0)
  ) +
  ggplot2::labs(
    title = paste0(DriftID, " | Event ", evNum, " | Tukey | Per UID"),
    x = "Frequency (kHz)",
    y = "Number of clicks"
  ) +
  ggplot2::theme_grey(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    panel.grid.minor = ggplot2::element_blank(),  # reduces the “striping”
    plot.title = ggplot2::element_text(face = "bold")
  )

print(p_uid)

out_png <- file.path(eventDir, sprintf("%s_Event_%03d_Tukey_2x2_perUID.png", DriftID, evNum))
ggplot2::ggsave(out_png, p_uid, width = 12, height = 7, dpi = 300)
message("Saved: ", out_png)

```
