---
title: "05_Lifter_Events"
output: html_document
date: "2025-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Start by loading the required packages

```{r, load packages, message=FALSE}
library("easypackages") 
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr","tidyr","ggplot2")
```

## Define functions for liftering and plotting spectra

Follow general approach of Soldevilla et al 2017. Apply high-pass lifter to remove first 6 quefrencies.

```{r}
source(here('R','lifteredClickCalcs.R'))
```

## Define PAMpal settings

```{r}
###USER-DEFINED FIELDS####
baseDir <- 'E:/Analysis/'
DriftID<-'ADRIFT_033'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries

# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')

pps <- PAMpalSettings(db=db, 
                      binaries = binFolder,
                      sr_hz='auto', 
                      winLen_sec=.0025, 
                      filterfrom_khz=10, 
                      filterto_khz=80)
```

## Generate New Acoustic Study

```{r}
#Add liftering function
pps <- addFunction(pps, lifteredClickCalcs, 
                   module = "ClickDetector", 
                   default = TRUE, # don't prompt for anything
                   sr_hz         = "auto",
                   calibration   = NULL,
                   filterfrom_khz = 10,      
                   filterto_khz   = 80,    
                   winLen_sec     = 0.0025) 


# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)

lifters <- getClickData(study)
```

## Plot Concatenated Spectrograms & Mean Spectra of Liftered Events

```{r}
out_root <-  file.path(baseDir,'LifteredSpectra')
drift_dir <- fs::path(out_root, DriftID)
dir_create(drift_dir)

#Most studies only have 1 event. Change this for events with multiple studies (will need to define 'waves' for each event)
event_ids<-1
lifters<-lifters %>% 
  dplyr::filter(eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)

sr    <- study[[1]]@settings$sr
waves <- lifters$liftered_wave
waves <- waves[!is.na(waves)]

#Pre-create all event folders
event_names <- paste0(DriftID, "_Event_", str_pad(event_ids, 3, pad = "0"))
# event_dirs  <- fs::path(drift_dir, event_names)
# fs::dir_create(event_dirs)

#Loop: one call per event -> two plots auto-saved -> rename
for (k in seq_along(event_ids)) {
  i      <- event_ids[k]
  # ev_dir <- event_dirs[k]
  ev_tag <- event_names[k]

  #Plot and save images
  pattern <- fs::path(drift_dir, paste0(ev_tag,"_ConcatSpectrogram.png"))
  png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
  
  plotClickSpectrogram(
  waves  = waves,
  sr     = sr,
  nfft   = 512,
  flim   = c(0, 100000),   
  log_freq = FALSE,
  main     = paste0('Liftered spectra:', ev_tag)
)
  dev.off()

 pattern <- fs::path(drift_dir, paste0(ev_tag, "_MeanSpectrum.png"))
  png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
  plotMeanClickSpectrum(
  waves  = waves,
  sr     = sr,
  nfft   = 512,
  flim   = c(0, 100000),
  log_freq =FALSE, 
  main     = paste0('Mean spectrum after liftering: ',ev_tag)
)
   dev.off()
  
}


```

## Plot parameter pairs to investigate impact of liftering

```{r}

# identify liftered parameters
lifter_cols <- grep("^liftered_", names(lifters), value = TRUE)

# corresponding original names
orig_cols <- sub("^liftered_", "", lifter_cols)

pairs <- data.frame(
  original = orig_cols,
  liftered = lifter_cols
)
pairs

#Reshape to long format for ggplot
data_long <- pairs %>%
  # pivot each pair into long format and bind them together
  purrr::pmap_dfr(function(original, liftered) {
    lifters %>%
      select(all_of(c(original, liftered))) %>%
      pivot_longer(
        cols = everything(),
        names_to = "parameter",
        values_to = "value"
      ) %>%
      mutate(pair = original,
             type = ifelse(parameter == original, "original", "liftered"))
  })

#Plot
ggplot(data_long, aes(x = type, y = value, fill = type)) +
  geom_boxplot() +
  facet_wrap(~ pair, scales = "free_y") +
  labs(
    title = "Effect of Liftering on Click Parameters",
    x = "",
    y = "Value"
  ) +
  scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
  theme_bw() 
```
