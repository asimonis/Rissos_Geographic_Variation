---
title: "PeakPickingOptions"
author: "Sarah Shiers"
date: "2026-01-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Start by loading the required packages

```{r, load packages, message=FALSE}
library("easypackages") 
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr","tidyr","ggplot2")
```

## Load required packages

```{r}

source(here('R',"TukeySmoothing.R"))

###USER-DEFINED FIELDS####
baseDir <- 'E:/Analysis/'
DriftID<-'ADRIFT_033'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries

# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')

pps <- PAMpalSettings(db=db, 
                      binaries = binFolder,
                      sr_hz='auto', 
                      winLen_sec=.0025, 
                      filterfrom_khz=10, 
                      filterto_khz=80)

study <- processPgDetections(pps)

study<-dplyr::filter(study,Channel==1)       
 
#Calculate average spectrum with and without Tukey smoothing
#Use 1024 window length for 375 Hz frequency resolution (Soldevilla used 400 Hz) 
smooth <- calculateAverageSpectra_tukey(
  study,
  evNum = 1,
  channel=1,
  tukeyMedian = 5,
  tukeyHanningSize = 5,
  plot=FALSE,
  wl=1024
)

raw <- calculateAverageSpectra(
  study,
  evNum = 1,
  channel=1,
  plot=FALSE,
  wl=1024
)

ylim <- range(c(raw$avgSpec, smooth$avgSpec), na.rm = TRUE)

```

### Plot click spectra showing raw signal, with 5-point Hann smooth and Tukey double smooth  

```{r}

#Plot one click
plot(raw$freq,raw$allSpec[,1],type='l',xlab="Frequency (kHz)",ylab="Level(dB)",xlim=c(19000,50000))
lines(smooth$freq, smooth$allSpec[,1], lwd = 2)
legend("bottomright", legend = c("Raw", "Tukey"), lwd = c(1, 2), bty = "n")

#Plot a single click by UID, then step through clicks interactively (press Enter to advance)next
browse_clicks(raw, tukeyMedian = 5, tukeyHanningSize = 5, fmin_khz = 19, fmax_khz = 50)
```

### Addition of pracma::findpeaks to Raw

```{R}

#Load pracma library
library(pracma)

#Ensure kHz is being used
to_khz <- function(freq) {
  if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq
}

#Hanning smoothing (still computed here in case you need it later)
hann5_smooth <- function(y) {
  w <- signal::hanning(5)
  w <- w / sum(w)

  y_pad <- c(rep(y[1], 2), y, rep(y[length(y)], 2))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[3:(length(y_filt) - 2)])
}

#Select one click and build spectra
click_i <- 1  #Change number to test different clicks

#Click UID
click_uid <- as.character(raw$UID[click_i])

freq_khz <- to_khz(raw$freq)

y_raw   <- raw$allSpec[, click_i]
y_tukey <- smooth$allSpec[, click_i]
y_hann5 <- hann5_smooth(y_raw)

#First spectrum to test with pracma: Raw
y <- y_raw

#Banding restriction (kHz)
band <- freq_khz >= 19 & freq_khz <= 50 & is.finite(y)
x_band <- freq_khz[band]
y_band <- y[band]

#Frequency resolution of the spectrum (kHz per FFT bin)
freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)

#Minimum allowed separation between peaks, in kHz
min_peak_separation_khz <- 0.3
peak_height_quantile <- 0.10

# Convert separation from kHz to number of frequency bins
min_peak_separation_bins <- max(
  1, round(min_peak_separation_khz / freq_resolution_khz)
)

#Minimum peak height threshold (quantile-based)
min_peak_height_db <- as.numeric(
  quantile(y_band, probs = peak_height_quantile, na.rm = TRUE)
)

#Find peaks
peaks <- pracma::findpeaks(
  y_band,
  minpeakheight   = min_peak_height_db,
  minpeakdistance = min_peak_separation_bins
)

#Convert pracma output into a readable table (freq + height)
if (is.null(peaks) || nrow(peaks) == 0) {
  detected_peaks_khz_db_Raw <- data.frame(freq_khz = numeric(), height_db = numeric())
} else {
  peak_indices <- peaks[, 2]
  detected_peaks_khz_db_Raw <- data.frame(
    freq_khz  = x_band[peak_indices],
    height_db = y_band[peak_indices]
  )
}

#Dataframe
detected_peaks_khz_db_Raw

#Visual confirmation from spectrum (Raw)
plot(
  freq_khz,
  y_raw,
  type = "l",
  xlab = "Frequency (kHz)",
  ylab = "Level (dB)",
  xlim = c(19, 50),
  ylim = c(-120, max(y_raw, na.rm = TRUE)),
  main = paste0("UID: ", click_uid, " — Raw spectrum")
)

#Overlay detected peak locations and label values 
if (nrow(detected_peaks_khz_db_Raw) > 0) {

  points(
    detected_peaks_khz_db_Raw$freq_khz,
    detected_peaks_khz_db_Raw$height_db,
    pch = 19
  )

  text(
    detected_peaks_khz_db_Raw$freq_khz,
    detected_peaks_khz_db_Raw$height_db,
    labels = round(detected_peaks_khz_db_Raw$freq_khz, 2),
    pos = 3,
    cex = 0.7
  )
}

```

### Addition of pracma::findpeaks to Tukey

```{r}

#Load pracma library
library(pracma)

#Ensure kHz is being used
to_khz <- function(freq) {
  if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq
}

#Hanning smoothing
hann5_smooth <- function(y) {
  w <- signal::hanning(5)
  w <- w / sum(w)

  y_pad <- c(rep(y[1], 2), y, rep(y[length(y)], 2))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[3:(length(y_filt) - 2)])
}

#Select one click and build spectra
click_i <- 1  #Change number to test different clicks

#Click UID
click_uid <- as.character(raw$UID[click_i])

freq_khz <- to_khz(raw$freq)

y_raw   <- raw$allSpec[, click_i]
y_tukey <- smooth$allSpec[, click_i]
y_hann5 <- hann5_smooth(y_raw)

#Set Tukey
y <- y_tukey

#Banding restriction (kHz)
band <- freq_khz >= 19 & freq_khz <= 50 & is.finite(y)
x_band <- freq_khz[band]
y_band <- y[band]

#Frequency resolution of the spectrum (kHz per FFT bin)
freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)

#Minimum allowed separation between peaks, in kHz
min_peak_separation_khz <- 0.3
peak_height_quantile <- 0.10

# Convert separation from kHz to number of frequency bins
min_peak_separation_bins <- max(
  1, round(min_peak_separation_khz / freq_resolution_khz)
)

#Minimum peak height threshold (quantile-based)
min_peak_height_db <- as.numeric(
  quantile(y_band, probs = peak_height_quantile, na.rm = TRUE)
)

#Find peaks
peaks <- pracma::findpeaks(
  y_band,
  minpeakheight   = min_peak_height_db,
  minpeakdistance = min_peak_separation_bins
)


#Convert pracma output into a readable table (freq + height)
if (is.null(peaks) || nrow(peaks) == 0) {
  detected_peaks_khz_db_Tukey <- data.frame(freq_khz = numeric(), height_db = numeric())
} else {
  peak_indices <- peaks[, 2]
  detected_peaks_khz_db_Tukey <- data.frame(
    freq_khz  = x_band[peak_indices],
    height_db = y_band[peak_indices]
  )
}

#Dataframe
detected_peaks_khz_db_Tukey

#Visual confirmation from spectrum
plot(
  freq_khz,
  y_tukey,
  type = "l",
  xlab = "Frequency (kHz)",
  ylab = "Level (dB)",
  xlim = c(19, 50),
  ylim = c(-120, max(y_tukey, na.rm = TRUE)),
  main = paste0("UID: ", click_uid, " — Tukey-smoothed spectrum")
)

#Overlay detected peak locations and label values 
if (nrow(detected_peaks_khz_db_Tukey) > 0) {

  points(
    detected_peaks_khz_db_Tukey$freq_khz,
    detected_peaks_khz_db_Tukey$height_db,
    pch = 19
  )

  text(
    detected_peaks_khz_db_Tukey$freq_khz,
    detected_peaks_khz_db_Tukey$height_db,
    labels = round(detected_peaks_khz_db_Tukey$freq_khz, 2),
    pos = 3,
    cex = 0.7
  )
}

```

### Addition of pracma::findpeaks to Hanning

```{R}

#Ensure kHz is being used
to_khz <- function(freq) {
  if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq
}

#Hanning smoothing (5-point Hann)
hann5_smooth <- function(y) {
  w <- signal::hanning(5)
  w <- w / sum(w)

  y_pad <- c(rep(y[1], 2), y, rep(y[length(y)], 2))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[3:(length(y_filt) - 2)])
}

#Select one click and build spectra
click_i <- 1  #Change number to test different clicks

#Click UID
click_uid <- as.character(raw$UID[click_i])

freq_khz <- to_khz(raw$freq)

y_raw   <- raw$allSpec[, click_i]
y_tukey <- smooth$allSpec[, click_i]
y_hann5 <- hann5_smooth(y_raw)

#Second spectrum to test with pracma: Hann-5
y <- y_hann5

#Banding restriction (kHz)
band <- freq_khz >= 19 & freq_khz <= 50 & is.finite(y)
x_band <- freq_khz[band]
y_band <- y[band]

#Frequency resolution of the spectrum (kHz per FFT bin)
freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)

#Minimum allowed separation between peaks, in kHz
min_peak_separation_khz <- 0.3
peak_height_quantile <- 0.10

# Convert separation from kHz to number of frequency bins
min_peak_separation_bins <- max(
  1, round(min_peak_separation_khz / freq_resolution_khz)
)

#Minimum peak height threshold (quantile-based)
min_peak_height_db <- as.numeric(
  quantile(y_band, probs = peak_height_quantile, na.rm = TRUE)
)

#Find peaks
peaks <- pracma::findpeaks(
  y_band,
  minpeakheight   = min_peak_height_db,
  minpeakdistance = min_peak_separation_bins
)

#Convert pracma output into a readable table (freq + height)
if (is.null(peaks) || nrow(peaks) == 0) {
  detected_peaks_khz_db_Hanning <- data.frame(freq_khz = numeric(), height_db = numeric())
} else {
  peak_indices <- peaks[, 2]
  detected_peaks_khz_db_Hanning <- data.frame(
    freq_khz  = x_band[peak_indices],
    height_db = y_band[peak_indices]
  )
}

#Dataframe
detected_peaks_khz_db_Hanning

#Visual confirmation from spectrum (Hann-5)
plot(
  freq_khz,
  y_hann5,
  type = "l",
  xlab = "Frequency (kHz)",
  ylab = "Level (dB)",
  xlim = c(19, 50),
  ylim = c(-120, max(y_hann5, na.rm = TRUE)),
  main = paste0("UID: ", click_uid, " — Hann-5 smoothed spectrum")
)

#Overlay detected peak locations and label values
if (nrow(detected_peaks_khz_db_Hanning) > 0) {

  points(
    detected_peaks_khz_db_Hanning$freq_khz,
    detected_peaks_khz_db_Hanning$height_db,
    pch = 19
  )

  text(
    detected_peaks_khz_db_Hanning$freq_khz,
    detected_peaks_khz_db_Hanning$height_db,
    labels = round(detected_peaks_khz_db_Hanning$freq_khz, 2),
    pos = 3,
    cex = 0.7
  )
}

```



### Combined plot: Raw vs Tukey vs Hann5 with pracma peaks labeled

```{r}

spectra_by_smoothing <- list(
  Raw   = y_raw,
  Tukey = y_tukey,
  Hann5 = y_hann5
)

# Peak-picking settings (keep consistent across Raw/Tukey/Hann5)
min_peak_separation_khz <- 0.3
peak_height_quantile    <- 0.10

#Run pracma peak picking and return a clean peak table
detect_peaks_pracma <- function(y, freq_khz,
                                fmin_khz = 19, fmax_khz = 50,
                                min_peak_separation_khz = 0.3,
                                peak_height_quantile = 0.10) {

  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)

  # Convert separation from kHz to number of bins
  min_peak_separation_bins <- max(
    1, round(min_peak_separation_khz / freq_resolution_khz)
  )

  # Quantile-based minimum peak height
  min_peak_height_db <- as.numeric(
    quantile(y_band, probs = peak_height_quantile, na.rm = TRUE)
  )

  peaks <- pracma::findpeaks(
    y_band,
    minpeakheight   = min_peak_height_db,
    minpeakdistance = min_peak_separation_bins
  )

  if (is.null(peaks) || nrow(peaks) == 0) {
    detected_peaks_khz_db <- data.frame(
      peak_frequency_khz = numeric(),
      peak_level_db      = numeric()
    )
  } else {
    peak_indices <- peaks[, 2]
    detected_peaks_khz_db <- data.frame(
      peak_frequency_khz = x_band[peak_indices],
      peak_level_db      = y_band[peak_indices]
    )
  }

  list(
    params = list(
      freq_resolution_khz      = freq_resolution_khz,
      min_peak_height_db       = min_peak_height_db,
      min_peak_separation_bins = min_peak_separation_bins
    ),
    detected_peaks_khz_db = detected_peaks_khz_db
  )
}

#Run peak picking for each smoothing type (uses the consistent settings above)
peaks_by_smoothing <- lapply(
  spectra_by_smoothing,
  detect_peaks_pracma,
  freq_khz = freq_khz,
  fmin_khz = 19,
  fmax_khz = 50,
  min_peak_separation_khz = min_peak_separation_khz,
  peak_height_quantile    = peak_height_quantile
)

#Plot all three spectra on the same axes
y_all <- c(y_raw, y_tukey, y_hann5)
plot(
  freq_khz,
  y_tukey,
  type = "l",
  xlab = "Frequency (kHz)",
  ylab = "Level (dB)",
  xlim = c(19, 50),
  ylim = c(-120, max(y_all, na.rm = TRUE) + 3),
  main = paste0("UID: ", click_uid, " — Raw vs Tukey vs Hann5 + Peaks")
)

lines(freq_khz, y_raw)           # Raw
lines(freq_khz, y_hann5, lty=2)  # Hann5

legend(
  "bottomright",
  legend = c("Raw", "Tukey", "Hann5"),
  lty = c(1, 1, 2),
  bty = "n"
)

#Overlay peak points and label peak frequencies for each smoothing type
label_peaks <- function(peak_df, label_prefix = "") {
  if (is.null(peak_df) || nrow(peak_df) == 0) return()

  points(peak_df$peak_frequency_khz, peak_df$peak_level_db, pch = 19, cex = 0.6)

  par(xpd = NA)  # allow labels near the edges
  text(
    peak_df$peak_frequency_khz,
    peak_df$peak_level_db,
    labels = paste0(label_prefix, round(peak_df$peak_frequency_khz, 2)),
    pos = 3,
    cex = 0.55
  )
  par(xpd = FALSE)
}

label_peaks(peaks_by_smoothing$Raw$detected_peaks_khz_db,   label_prefix = "R:")
label_peaks(peaks_by_smoothing$Tukey$detected_peaks_khz_db, label_prefix = "T:")
label_peaks(peaks_by_smoothing$Hann5$detected_peaks_khz_db, label_prefix = "H:")


```

### Table for all smoothing types

```{R}

#Table for all smoothing types (from peaks_by_smoothing)
detected_peaks_khz_db_All <- dplyr::bind_rows(
  data.frame(
    UID = click_uid,
    smoothing = "Raw",
    peak_frequency_khz = peaks_by_smoothing$Raw$detected_peaks_khz_db$peak_frequency_khz,
    peak_level_db      = peaks_by_smoothing$Raw$detected_peaks_khz_db$peak_level_db,
    stringsAsFactors = FALSE
  ),
  data.frame(
    UID = click_uid,
    smoothing = "Tukey",
    peak_frequency_khz = peaks_by_smoothing$Tukey$detected_peaks_khz_db$peak_frequency_khz,
    peak_level_db      = peaks_by_smoothing$Tukey$detected_peaks_khz_db$peak_level_db,
    stringsAsFactors = FALSE
  ),
  data.frame(
    UID = click_uid,
    smoothing = "Hann5",
    peak_frequency_khz = peaks_by_smoothing$Hann5$detected_peaks_khz_db$peak_frequency_khz,
    peak_level_db      = peaks_by_smoothing$Hann5$detected_peaks_khz_db$peak_level_db,
    stringsAsFactors = FALSE
  )
)

#Dataframe
detected_peaks_khz_db_All


```







