---
title: "PeakandNotchComparisons_Histograms"
author: "Sarah Shiers"
date: "2026-01-23"
output: html_document
---

```{r}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

### Install packages 

```{r}

library("easypackages")
libraries(
  "PAMpal","PAMmisc","dplyr","here","lubridate","purrr","signal","fs","stringr",
  "tidyr","ggplot2","pracma","quantmod","tibble"
)

source(here('R',"TukeySmoothing.R"))

```

### User-defined drift ID and event number

```{r}

baseDir <- "E:/Analysis/"
histBaseDir <- "E:/Analysis/Event Histograms"

DriftID <- "ADRIFT_033"
evNum   <- 1

channel <- 1
wl      <- 1024

# Peak/notch band (kHz)
fmin_khz <- 19
fmax_khz <- 50

# Peak picking settings
min_peak_separation_khz <- 0.3
peak_height_quantile    <- 0.10

# Tukey settings
tukeyMedian      <- 5
tukeyHanningSize <- 5

# Output settings
hist_bins <- 40
img_w <- 10
img_h <- 6
img_dpi <- 300

```

### Helper functions

```{r}

to_khz <- function(freq) {
  if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq
}

hann5_smooth <- function(y) {
  w <- signal::hanning(5)
  w <- w / sum(w)
  y_pad <- c(rep(y[1], 2), y, rep(y[length(y)], 2))
  y_filt <- stats::filter(y_pad, filter = w, sides = 2)
  as.numeric(y_filt[3:(length(y_filt) - 2)])
}

detect_peaks_pracma <- function(y, freq_khz, fmin_khz, fmax_khz,
                               min_peak_separation_khz, peak_height_quantile) {
  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  if (length(x_band) < 3) return(numeric(0))

  freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)
  min_peak_separation_bins <- max(1, round(min_peak_separation_khz / freq_resolution_khz))
  min_peak_height_db <- as.numeric(quantile(y_band, probs = peak_height_quantile, na.rm = TRUE))

  peaks <- pracma::findpeaks(
    y_band,
    minpeakheight   = min_peak_height_db,
    minpeakdistance = min_peak_separation_bins
  )

  if (is.null(peaks) || nrow(peaks) == 0) numeric(0) else x_band[peaks[,2]]
}

detect_notches_quantmod <- function(y, freq_khz, fmin_khz, fmax_khz, shift_back=TRUE) {
  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  if (length(x_band) < 3) return(numeric(0))

  notch_idx <- quantmod::findValleys(y_band)
  if (length(notch_idx) == 0) return(numeric(0))

  if (shift_back) notch_idx <- pmax(1, notch_idx - 1)
  x_band[notch_idx]
}

make_hist <- function(df, value_col, title, xlab, fmin_khz, fmax_khz, bins = 40) {
  x_major <- seq(fmin_khz, fmax_khz, by = 1)
  x_minor <- seq(fmin_khz, fmax_khz, by = 0.5)

  ggplot(df, aes(x = .data[[value_col]])) +
    geom_histogram(bins = bins) +
    scale_x_continuous(
      breaks = x_major,
      minor_breaks = x_minor,
      limits = c(fmin_khz, fmax_khz)
    ) +
    labs(x = xlab, y = "Number of clicks", title = title) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

save_plot <- function(p, filename, w = 10, h = 6, dpi = 300) {
  ggsave(filename, p, width = w, height = h, dpi = dpi)
}

```

### Load study for this drift

```{r}

binFolder <- file.path(baseDir, "Binaries", DriftID)
db <- file.path(baseDir, "Useable Databases", paste0(DriftID, " - Clean.sqlite3"))

pps <- PAMpalSettings(
  db = db,
  binaries = binFolder,
  sr_hz = "auto",
  winLen_sec = .0025,
  filterfrom_khz = 10,
  filterto_khz = 80
)

study <- processPgDetections(pps) %>% dplyr::filter(Channel == channel)

```

### Process THIS event only into event-only dataframes

```{r}

message("Processing DriftID=", DriftID, " Event=", evNum)

smooth <- calculateAverageSpectra_tukey(
  study,
  evNum = evNum,
  channel = channel,
  tukeyMedian = tukeyMedian,
  tukeyHanningSize = tukeyHanningSize,
  plot = FALSE,
  wl = wl
)

raw <- calculateAverageSpectra(
  study,
  evNum = evNum,
  channel = channel,
  plot = FALSE,
  wl = wl
)

freq_khz <- to_khz(raw$freq)
n_clicks <- ncol(raw$allSpec)

if (is.null(n_clicks) || n_clicks == 0) {
  stop("No clicks found for this event. Check DriftID, evNum, channel.")
}

# Event-only dataframes (fresh every run)
df_peaks <- tibble::tibble(
  DriftID = character(),
  Event   = integer(),
  UID     = character(),
  smoothing = character(),
  peak_khz  = numeric()
)

df_notches <- tibble::tibble(
  DriftID = character(),
  Event   = integer(),
  UID     = character(),
  smoothing = character(),
  notch_khz = numeric()
)

for (i in seq_len(n_clicks)) {
  uid <- as.character(raw$UID[i])

  y_raw   <- raw$allSpec[, i]
  y_tukey <- smooth$allSpec[, i]
  y_hann5 <- hann5_smooth(y_raw)

  # Tukey
  tukey_peaks <- detect_peaks_pracma(
    y_tukey, freq_khz, fmin_khz, fmax_khz,
    min_peak_separation_khz, peak_height_quantile
  )
  tukey_notches <- detect_notches_quantmod(
    y_tukey, freq_khz, fmin_khz, fmax_khz, shift_back = TRUE
  )

  # Hann5
  hann_peaks <- detect_peaks_pracma(
    y_hann5, freq_khz, fmin_khz, fmax_khz,
    min_peak_separation_khz, peak_height_quantile
  )
  hann_notches <- detect_notches_quantmod(
    y_hann5, freq_khz, fmin_khz, fmax_khz, shift_back = TRUE
  )

  if (length(tukey_peaks) > 0) {
    df_peaks <- dplyr::bind_rows(
      df_peaks,
      tibble::tibble(DriftID = DriftID, Event = evNum, UID = uid, smoothing = "Tukey", peak_khz = tukey_peaks)
    )
  }
  if (length(hann_peaks) > 0) {
    df_peaks <- dplyr::bind_rows(
      df_peaks,
      tibble::tibble(DriftID = DriftID, Event = evNum, UID = uid, smoothing = "Hann5", peak_khz = hann_peaks)
    )
  }

  if (length(tukey_notches) > 0) {
    df_notches <- dplyr::bind_rows(
      df_notches,
      tibble::tibble(DriftID = DriftID, Event = evNum, UID = uid, smoothing = "Tukey", notch_khz = tukey_notches)
    )
  }
  if (length(hann_notches) > 0) {
    df_notches <- dplyr::bind_rows(
      df_notches,
      tibble::tibble(DriftID = DriftID, Event = evNum, UID = uid, smoothing = "Hann5", notch_khz = hann_notches)
    )
  }
}

df_peaks
df_notches

```

### Make and save histograms for this event

```{r}

# Ensure drift output folder exists
# Ensure drift + event output folders exist
driftHistDir <- file.path(histBaseDir, DriftID)
eventFolderName <- sprintf("Event_%03d", evNum)
eventHistDir <- file.path(driftHistDir, eventFolderName)

if (!dir.exists(eventHistDir)) dir.create(eventHistDir, recursive = TRUE)

# Filter per smoothing type
tukey_peaks_df   <- dplyr::filter(df_peaks, smoothing == "Tukey")
tukey_notches_df <- dplyr::filter(df_notches, smoothing == "Tukey")
hann_peaks_df    <- dplyr::filter(df_peaks, smoothing == "Hann5")
hann_notches_df  <- dplyr::filter(df_notches, smoothing == "Hann5")

# Create plots
p_tp <- make_hist(tukey_peaks_df, "peak_khz",
                  paste0(DriftID, " | Event ", evNum, " | Tukey Peaks"),
                  "Peak frequency (kHz)", fmin_khz, fmax_khz, hist_bins)

p_tn <- make_hist(tukey_notches_df, "notch_khz",
                  paste0(DriftID, " | Event ", evNum, " | Tukey Notches"),
                  "Notch frequency (kHz)", fmin_khz, fmax_khz, hist_bins)

p_hp <- make_hist(hann_peaks_df, "peak_khz",
                  paste0(DriftID, " | Event ", evNum, " | Hann5 Peaks"),
                  "Peak frequency (kHz)", fmin_khz, fmax_khz, hist_bins)

p_hn <- make_hist(hann_notches_df, "notch_khz",
                  paste0(DriftID, " | Event ", evNum, " | Hann5 Notches"),
                  "Notch frequency (kHz)", fmin_khz, fmax_khz, hist_bins)

# Filenames
f_tp <- file.path(eventHistDir, sprintf("%s_Event_%03d_Tukey_Peaks.png",   DriftID, evNum))
f_tn <- file.path(eventHistDir, sprintf("%s_Event_%03d_Tukey_Notches.png", DriftID, evNum))
f_hp <- file.path(eventHistDir, sprintf("%s_Event_%03d_Hann5_Peaks.png",   DriftID, evNum))
f_hn <- file.path(eventHistDir, sprintf("%s_Event_%03d_Hann5_Notches.png", DriftID, evNum))

# Save
save_plot(p_tp, f_tp, w = img_w, h = img_h, dpi = img_dpi)
save_plot(p_tn, f_tn, w = img_w, h = img_h, dpi = img_dpi)
save_plot(p_hp, f_hp, w = img_w, h = img_h, dpi = img_dpi)
save_plot(p_hn, f_hn, w = img_w, h = img_h, dpi = img_dpi)

message("Saved histograms to: ", eventHistDir)

```
















