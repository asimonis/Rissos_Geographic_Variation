---
title: "PeakandNotchComparisons_Histograms"
author: "Sarah Shiers"
date: "2026-01-23"
output: html_document
---

```{r}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

### Install packages 

```{r}

library("easypackages")
libraries(
  "PAMpal","PAMmisc","dplyr","here","lubridate","purrr","signal","fs","stringr",
  "tidyr","ggplot2","pracma","quantmod","tibble"
)

source(here('R',"TukeySmoothing.R"))

```

### User-defined drift ID and event number

```{r}

# Base directories
baseDir <- "E:/Analysis"
extremaBaseDir <- file.path(baseDir, "Event Extrema")
histBaseDir    <- file.path(baseDir, "Event Histograms")

# Study identifiers
DriftID <- "ADRIFT_003"
evNum   <- 1
channel <- 1

# Spectral parameters
wl <- 1024

# Frequency band (kHz)
fmin_khz <- 19
fmax_khz <- 50

# Peak picking parameters
min_peak_separation_khz <- 0.3
peak_height_quantile    <- 0.10

# Tukey parameters
tukeyMedian      <- 5
tukeyHanningSize <- 5

# Histogram output
hist_bins <- 40
img_w <- 10
img_h <- 6
img_dpi <- 300

```

### Helper functions

```{r}

to_khz <- function(freq) {
  if (max(freq, na.rm = TRUE) > 1000) freq / 1000 else freq
}

detect_peaks_pracma <- function(y, freq_khz, fmin_khz, fmax_khz,
                               min_peak_separation_khz, peak_height_quantile) {

  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  if (length(x_band) < 3) return(numeric(0))

  freq_resolution_khz <- median(diff(x_band), na.rm = TRUE)
  min_peak_separation_bins <- max(
    1, round(min_peak_separation_khz / freq_resolution_khz)
  )

  min_peak_height_db <- as.numeric(
    quantile(y_band, probs = peak_height_quantile, na.rm = TRUE)
  )

  peaks <- pracma::findpeaks(
    y_band,
    minpeakheight   = min_peak_height_db,
    minpeakdistance = min_peak_separation_bins
  )

  if (is.null(peaks) || nrow(peaks) == 0) numeric(0) else x_band[peaks[, 2]]
}

detect_notches_quantmod <- function(y, freq_khz, fmin_khz, fmax_khz) {

  band <- freq_khz >= fmin_khz & freq_khz <= fmax_khz & is.finite(y)
  x_band <- freq_khz[band]
  y_band <- y[band]

  if (length(x_band) < 3) return(numeric(0))

  idx <- quantmod::findValleys(y_band)
  if (length(idx) == 0) return(numeric(0))

  idx <- pmax(1, idx - 1)
  x_band[idx]
}

```

### Load Study

```{r}

binFolder <- file.path(baseDir, "Binaries", DriftID)
db <- file.path(
  baseDir,
  "Useable Databases",
  paste0(DriftID, " - Clean.sqlite3")
)

pps <- PAMpalSettings(
  db = db,
  binaries = binFolder,
  sr_hz = "auto",
  winLen_sec = 0.0025,
  filterfrom_khz = 10,
  filterto_khz = 80
)

study <- processPgDetections(pps) |>
  dplyr::filter(Channel == channel)

```

### Create output directories

```{r}

eventFolderName <- sprintf("Event_%03d", evNum)

eventExtremaDir <- file.path(extremaBaseDir, DriftID, eventFolderName)
eventHistDir    <- file.path(histBaseDir,    DriftID, eventFolderName)

if (!dir.exists(eventExtremaDir)) {
  dir.create(eventExtremaDir, recursive = TRUE)
}

if (!dir.exists(eventHistDir)) {
  dir.create(eventHistDir, recursive = TRUE)
}

```

### Tukey spectra

```{r}

tukey_spectra <- calculateAverageSpectra_tukey(
  study,
  evNum = evNum,
  channel = channel,
  tukeyMedian = tukeyMedian,
  tukeyHanningSize = tukeyHanningSize,
  plot = FALSE,
  wl = wl
)

freq_khz <- to_khz(tukey_spectra$freq)
n_clicks <- ncol(tukey_spectra$allSpec)

if (is.null(n_clicks) || n_clicks == 0) {
  stop("No clicks found for this event.")
}

```

### Detect extrema (event-level)

```{r}

tukey_event_extrema <- tibble(
  DriftID        = character(),
  Event          = integer(),
  UID            = character(),
  extremum_type  = character(),  # "peak" or "notch"
  frequency_khz  = numeric()
)

for (i in seq_len(n_clicks)) {

  uid <- as.character(tukey_spectra$UID[i])
  y   <- tukey_spectra$allSpec[, i]

  peaks_khz <- detect_peaks_pracma(
    y, freq_khz, fmin_khz, fmax_khz,
    min_peak_separation_khz, peak_height_quantile
  )

  notches_khz <- detect_notches_quantmod(
    y, freq_khz, fmin_khz, fmax_khz
  )

  if (length(peaks_khz) > 0) {
    tukey_event_extrema <- bind_rows(
      tukey_event_extrema,
      tibble(
        DriftID,
        Event = evNum,
        UID = uid,
        extremum_type = "peak",
        frequency_khz = peaks_khz
      )
    )
  }

  if (length(notches_khz) > 0) {
    tukey_event_extrema <- bind_rows(
      tukey_event_extrema,
      tibble(
        DriftID,
        Event = evNum,
        UID = uid,
        extremum_type = "notch",
        frequency_khz = notches_khz
      )
    )
  }
}

# Sanity check
tukey_event_extrema

extrema_counts <- tukey_event_extrema %>%
  dplyr::count(extremum_type, name = "n_extrema")

extrema_counts

```

### Save RDS

```{r}

saveRDS(
  tukey_event_extrema,
  file.path(
    eventExtremaDir,
    sprintf("%s_Event_%03d_Tukey_Extrema.rds", DriftID, evNum)
  )
)

```

### Histograms

```{r}

# Common breaks and axis ticks (1 kHz)
breaks_1khz <- seq(fmin_khz, fmax_khz, by = 1)
x_ticks    <- seq(fmin_khz, fmax_khz, by = 1)

plot_histogram_to_file <- function(values, title, outfile) {

  png(outfile, width = img_w, height = img_h, units = "in", res = img_dpi)

  par(mar = c(5, 5, 4, 2))

  hist(
    values,
    breaks = breaks_1khz,
    xlim = c(fmin_khz, fmax_khz),
    main = title,
    xlab = "Frequency (kHz)",
    ylab = "Number of extrema",
    xaxt = "n"
  )

  axis(1, at = x_ticks)

  dev.off()
}

# Peaks
peak_vals <- tukey_event_extrema$frequency_khz[
  tukey_event_extrema$extremum_type == "peak"
]

plot_histogram_to_file(
  values  = peak_vals,
  title   = paste(DriftID, "| Event", evNum, "| Tukey Peaks"),
  outfile = file.path(
    eventHistDir,
    sprintf("%s_Event_%03d_Tukey_Peaks.png", DriftID, evNum)
  )
)

# Notches
notch_vals <- tukey_event_extrema$frequency_khz[
  tukey_event_extrema$extremum_type == "notch"
]

plot_histogram_to_file(
  values  = notch_vals,
  title   = paste(DriftID, "| Event", evNum, "| Tukey Notches"),
  outfile = file.path(
    eventHistDir,
    sprintf("%s_Event_%03d_Tukey_Notches.png", DriftID, evNum)
  )
)

```

### Bin data / sanity check

```{r}

# Build histogram objects (no plotting)
peak_hist <- hist(
  tukey_event_extrema$frequency_khz[
    tukey_event_extrema$extremum_type == "peak"
  ],
  breaks = breaks_1khz,
  plot = FALSE
)

notch_hist <- hist(
  tukey_event_extrema$frequency_khz[
    tukey_event_extrema$extremum_type == "notch"
  ],
  breaks = breaks_1khz,
  plot = FALSE
)

peak_bin_table <- tibble(
  bin_start_khz = breaks_1khz[-length(breaks_1khz)],
  bin_end_khz   = breaks_1khz[-1],
  n_peaks       = peak_hist$counts
) %>%
  dplyr::mutate(total_peaks = sum(n_peaks))

notch_bin_table <- tibble(
  bin_start_khz = breaks_1khz[-length(breaks_1khz)],
  bin_end_khz   = breaks_1khz[-1],
  n_notches     = notch_hist$counts
) %>%
  dplyr::mutate(total_notches = sum(n_notches))

peak_bin_table
notch_bin_table

```