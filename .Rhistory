xlab = "Click number",
ylab = "Frequency (Hz)",
main = main)
z <- t(spec_db)
z_norm <- (z - min(z, na.rm = TRUE)) /
(max(z, na.rm = TRUE) - min(z, na.rm = TRUE))
rasterImage(
as.raster(z_norm),
xleft   = 1,
xright  = n_clicks,
ybottom = min(freqs),
ytop    = max(freqs)
)
}
invisible(list(freqs = freqs, S_click_db = spec_db))
}
plotMeanClickSpectrum <- function(
waves,
sr,
nfft     = 512,
flim     = NULL,
log_freq = FALSE,
main     = "Mean spectrum across clicks"
) {
cs <- clickSpectraMatrix(waves, sr, nfft)
freqs   <- cs$freqs
spec_db <- cs$spec_db   # freq Ã— clicks
# apply frequency limits
if (!is.null(flim)) {
if (length(flim) != 2) stop("flim must be c(fmin, fmax)")
keep <- which(freqs >= flim[1] & freqs <= flim[2])
freqs   <- freqs[keep]
spec_db <- spec_db[keep, , drop = FALSE]
}
mean_spec_db <- rowMeans(spec_db, na.rm = TRUE)
# Convert frequency to kHz for plotting
freqs_khz <- freqs / 1000
# ---- PLOT (frequency in kHz) ----
if (!log_freq) {
plot(
freqs_khz, mean_spec_db,
type = "l",
xlab = "Frequency (kHz)",
ylab = "Mean spectrum (dB)",
main = main
)
} else {
plot(
freqs_khz, mean_spec_db,
type = "l",
log  = "x",
xlab = "Frequency (kHz)",
ylab = "Mean spectrum (dB)",
main = paste0(main, " (log freq)")
)
}
invisible(list(
freqs_khz     = freqs_khz,
mean_spec_db  = mean_spec_db
))
}
###USER-DEFINED FIELDS####
baseDir <- here('data')
DriftID<-'CCES_007'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries
# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)
View(study)
lifters <- getClickData(study)
unique(lifters$eventId)
unique(lifters$eventId)[1]
sr    <- study[[1]]@settings$sr
waves <- lifters$liftered_wave
waves <- waves[!is.na(waves)]
lifters <- getClickData(study)
out_root <-  file.path(baseDir,'LifteredSpectra')
drift_dir <- fs::path(out_root, DriftID)
dir_create(drift_dir)
#Most studies only have 1 event. Change this for events with multiple studies (will need to define 'waves' for each event)
event_ids<-1
lifters<-filter(lifters,eventId==unique(lifters$eventId)[1]) #choose 1st event (need to change for multi-event studies)
unique(lifters$eventId)[1]
unique(lifters$eventId)[[1]]
lifters<-filter(lifters,eventId==unique(lifters$eventId)[[1]]) #choose 1st event (need to change for multi-event studies)
lifters<-filter(lifters,eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)
lifters<-filter(lifters,eventId=="CCES_007 - Clean.OE1") #choose 1st event (need to change for multi-event studies)
lifters<-lifters %>%
dplyr::filter(eventId =="CCES_007 - Clean.OE1") #choose 1st event (need to change for multi-event studies)
lifters <- getClickData(study)
#Most studies only have 1 event. Change this for events with multiple studies (will need to define 'waves' for each event)
event_ids<-1
lifters<-lifters %>%
dplyr::filter(eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)
sr    <- study[[1]]@settings$sr
waves <- lifters$liftered_wave
waves <- waves[!is.na(waves)]
#Pre-create all event folders
event_names <- paste0(DriftID, "_Event_", str_pad(event_ids, 3, pad = "0"))
#Loop: one call per event -> two plots auto-saved -> rename
for (k in seq_along(event_ids)) {
i      <- event_ids[k]
# ev_dir <- event_dirs[k]
ev_tag <- event_names[k]
#Plot and save images
pattern <- fs::path(drift_dir, paste0(ev_tag,"_ConcatSpectrogram.png"))
png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
plotClickSpectrogram(
waves  = waves,
sr     = sr,
nfft   = 512,
flim   = c(0, 100000),
log_freq = FALSE,
main     = paste0('Liftered spectra:', ev_tag)
)
dev.off()
pattern <- fs::path(drift_dir, paste0(ev_tag, "_MeanSpectrum.png"))
png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
plotMeanClickSpectrum(
waves  = waves,
sr     = sr,
nfft   = 512,
flim   = c(0, 100000),
log_freq =FALSE,
main     = paste0('Mean spectrum after liftering: ',ev_tag)
)
dev.off()
}
DriftID<-'ADRIFT_006'
###USER-DEFINED FIELDS####
baseDir <- here('data')
DriftID<-'ADRIFT_006'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries
# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)
lifters <- getClickData(study)
lifters <- getClickData(study)
out_root <-  file.path(baseDir,'LifteredSpectra')
drift_dir <- fs::path(out_root, DriftID)
dir_create(drift_dir)
#Most studies only have 1 event. Change this for events with multiple studies (will need to define 'waves' for each event)
event_ids<-1
lifters<-lifters %>%
dplyr::filter(eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)
sr    <- study[[1]]@settings$sr
waves <- lifters$liftered_wave
waves <- waves[!is.na(waves)]
#Pre-create all event folders
event_names <- paste0(DriftID, "_Event_", str_pad(event_ids, 3, pad = "0"))
# event_dirs  <- fs::path(drift_dir, event_names)
# fs::dir_create(event_dirs)
#Loop: one call per event -> two plots auto-saved -> rename
for (k in seq_along(event_ids)) {
i      <- event_ids[k]
# ev_dir <- event_dirs[k]
ev_tag <- event_names[k]
#Plot and save images
pattern <- fs::path(drift_dir, paste0(ev_tag,"_ConcatSpectrogram.png"))
png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
plotClickSpectrogram(
waves  = waves,
sr     = sr,
nfft   = 512,
flim   = c(0, 100000),
log_freq = FALSE,
main     = paste0('Liftered spectra:', ev_tag)
)
dev.off()
pattern <- fs::path(drift_dir, paste0(ev_tag, "_MeanSpectrum.png"))
png(filename = pattern, width = 1600, height = 1000, res = 150, bg = "white")
plotMeanClickSpectrum(
waves  = waves,
sr     = sr,
nfft   = 512,
flim   = c(0, 100000),
log_freq =FALSE,
main     = paste0('Mean spectrum after liftering: ',ev_tag)
)
dev.off()
}
View(standardClickCalcs)
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
###USER-DEFINED FIELDS####
baseDir <- here('data')
DriftID<-'ADRIFT_006'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries
# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
library(PAMpal)
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
library("easypackages")
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purr","signal","fs","stringr")
install.packages('purr')
library("easypackages")
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purr","signal","fs","stringr")
library(purr)
library('purr')
install.packages('purr')
av <- available.packages(filters=list())
av[av[, "Package"] == purr, ]
library(purrr)
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr")
###USER-DEFINED FIELDS####
baseDir <- here('data')
DriftID<-'ADRIFT_006'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries
# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
View(standardClickCalcs)
??bwfilter
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
?? clipAroundPeak
library(PAMpal)
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
fun <- function(data = PAMpal::testClick) {
TKEO <- PAMpal:::TKEO   # local alias
wave <- data$wave       # example
result <- TKEO(wave)    # now this works
return(result)
}
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
???TKEO
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
??Qfast
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifterClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifterClickCalcs.R")
#Add liftering function
# pps <- addFunction(pps, hpLifterClick, module = "ClickDetector")
pps <- addFunction(pps, lifterClickCalcs, module = "ClickDetector")
# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)
View(study)
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
lifters <- getClickData(study)
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
library("easypackages")
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr")
source(here('data','R','lifteredClickCalcs.R'))
source(here('R','lifteredClickCalcs.R'))
###USER-DEFINED FIELDS####
baseDir <- here('data')
DriftID<-'ADRIFT_033'
binFolder <- paste0(baseDir,'/Binaries/',DriftID)    #Folder with binaries
# this database should be the cleaned copy
db <- paste0(baseDir,'/Databases/',DriftID,' - Clean.sqlite3')
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
#Add liftering function
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector")
# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
pps <- addFunction(pps, lifteredClickCalcs, module = "ClickDetector",
functionArgs = list(sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80))
source("C:/Users/annes/Documents/Github/Rissos_Geographic_Variation/R/lifteredClickCalcs.R")
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
?addFunction
pps <- PAMpalSettings(db=db,
binaries = binFolder,
sr_hz='auto',
winLen_sec=.0025,
filterfrom_khz=10,
filterto_khz=80)
#Add liftering function
pps <- addFunction(pps, lifteredClickCalcs,
module = "ClickDetector",
default = TRUE, # don't prompt for anything
sr_hz         = "auto",
calibration   = NULL,
filterfrom_khz = 10,
filterto_khz   = 80,
winLen_sec     = 0.0025)
# Re-run processing (uses your existing DB + settings)
study <- processPgDetections(pps)
library(ggplot2)
lifters<-lifters %>%
dplyr::filter(eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)
lifters <- getClickData(study)
#Most studies only have 1 event. Change this for events with multiple studies (will need to define 'waves' for each event)
event_ids<-1
lifters<-lifters %>%
dplyr::filter(eventId==(unique(lifters$eventId)[[1]])) #choose 1st event (need to change for multi-event studies)
ggplot(lifters,aes(peak,liftered_peak))+geom_bar()
ggplot(lifters,aes(peak,liftered_peak))+geom_boxplot()
saveRDS(lifters,file=here('data','LifteredSpectra','ExampleClicks.rds'))
# all liftered versions
lifter_cols <- grep("^liftered_", names(lifters), value = TRUE)
# corresponding original names
orig_cols <- sub("^liftered_", "", lifter_cols)
pairs <- data.frame(
original = orig_cols,
liftered = lifter_cols
)
pairs
#Reshape to long format for ggplot
data_long <- pairs %>%
# pivot each pair into long format and bind them together
purrr::pmap_dfr(function(original, liftered) {
liftered %>%
select(all_of(c(original, liftered))) %>%
pivot_longer(
cols = everything(),
names_to = "parameter",
values_to = "value"
) %>%
mutate(pair = original,
type = ifelse(parameter == original, "original", "liftered"))
})
#Reshape to long format for ggplot
data_long <- pairs %>%
# pivot each pair into long format and bind them together
purrr::pmap_dfr(function(original, liftered) {
lifters %>%
select(all_of(c(original, liftered))) %>%
pivot_longer(
cols = everything(),
names_to = "parameter",
values_to = "value"
) %>%
mutate(pair = original,
type = ifelse(parameter == original, "original", "liftered"))
})
library(tidyr)
#Reshape to long format for ggplot
data_long <- pairs %>%
# pivot each pair into long format and bind them together
purrr::pmap_dfr(function(original, liftered) {
lifters %>%
select(all_of(c(original, liftered))) %>%
pivot_longer(
cols = everything(),
names_to = "parameter",
values_to = "value"
) %>%
mutate(pair = original,
type = ifelse(parameter == original, "original", "liftered"))
})
libraries("PAMpal","PAMmisc","dplyr","here","beepr","lubridate","purrr","signal","fs","stringr","tidyr","ggplot2")
ggplot(df_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw() +
theme(legend.position = "none")
#Plot
ggplot(df_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw() +
theme(legend.position = "none")
#Plot
ggplot(data_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw() +
theme(legend.position = "none")
ggplot(data_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw() +
theme(legend.position = "none")
#Plot
ggplot(data_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw()
ggplot(data_long, aes(x = type, y = value, fill = type)) +
geom_boxplot() +
facet_wrap(~ pair, scales = "free_y") +
labs(
title = "Effect of Liftering on Click Parameters",
x = "",
y = "Value"
) +
scale_fill_manual(values = c("original" = "gray70", "liftered" = "steelblue")) +
theme_bw()
